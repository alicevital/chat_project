<!-- CHAT -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Privado</title>
  <link rel="stylesheet" href="../styles/styles.css">
</head>
<body>
  <div class="chat-container">
    <header class="chat-header">
      <h2>Chat Privado</h2>
      <a href="login.html" id="backHomeBtn" class="back-btn" onclick="disconnect()">Sair</a>
    </header>

    <!-- Seção para selecionar destinatário -->
    <div id="selectReceiverSection" class="receiver-section">
      <h3>Selecione com quem conversar</h3>
      <div class="input-group">
        <label>ID do Usuário Destinatário</label>
        <input type="text" id="receiverIdInput" placeholder="Digite o ID do usuário" required>
        <button onclick="connectToChat()">Conectar</button>
      </div>
      <div id="usersList" class="users-list"></div>
    </div>

    <!-- Seção do chat (inicialmente oculta) -->
    <div id="chatSection" class="chat-section" style="display: none;">
      <div class="chat-info">
        <p>Conversando com: <strong id="receiverName">-</strong> (ID: <span id="receiverIdDisplay">-</span>)</p>
        <button onclick="disconnectFromChat()">Trocar Conversa</button>
      </div>
      
      <!-- DIV na qual vai conter a lista de mensagens -->
      <div class="chat-box" id="messagesQueue"></div>

      <form class="chat-form" id="InsertForm">
        <input type="text" name="text" id="messageInput" placeholder="Digite sua mensagem..." required>
        <button type="submit">Enviar</button>
      </form>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:8000';
    let ws = null;
    let currentReceiverId = null;
    let currentUserId = null;
    let token = null;

    // Carrega token do localStorage
    token = localStorage.getItem('token');
    if (!token) {
      alert('Token não encontrado. Faça login novamente.');
      window.location.href = '/html/login.html';
    }

    // Carrega lista de usuários ao iniciar
    loadUsers();

    // Função para carregar lista de usuários
    async function loadUsers() {
      try {
        const response = await fetch(`${API_URL}/users`);
        if (response.ok) {
          const users = await response.json();
          const usersListDiv = document.getElementById('usersList');
          usersListDiv.innerHTML = '<h4>Usuários disponíveis:</h4>';
          
          users.forEach(user => {
            const userDiv = document.createElement('div');
            userDiv.className = 'user-item';
            userDiv.innerHTML = `
              <span><strong>${user.name}</strong></span>
              <span>ID: ${user.id}</span>
              <button onclick="selectReceiver('${user.id}', '${user.name}')">Conversar</button>
            `;
            usersListDiv.appendChild(userDiv);
          });
        }
      } catch (error) {
        console.error('Erro ao carregar usuários:', error);
      }
    }

    // Função para selecionar destinatário
    function selectReceiver(userId, userName) {
      document.getElementById('receiverIdInput').value = userId;
      connectToChat();
    }

    // Função para conectar ao chat
    async function connectToChat() {
      const receiverId = document.getElementById('receiverIdInput').value.trim();
      
      if (!receiverId) {
        alert('Por favor, digite o ID do destinatário');
        return;
      }

      if (!token) {
        alert('Token não encontrado. Faça login novamente.');
        window.location.href = '/html/login.html';
        return;
      }

      currentReceiverId = receiverId;
      
      // Obtém nome do destinatário
      try {
        const response = await fetch(`${API_URL}/users/${receiverId}`);
        if (response.ok) {
          const user = await response.json();
          document.getElementById('receiverName').textContent = user.name;
          document.getElementById('receiverIdDisplay').textContent = receiverId;
        }
      } catch (error) {
        console.error('Erro ao buscar usuário:', error);
      }

      // Oculta seção de seleção e mostra chat
      document.getElementById('selectReceiverSection').style.display = 'none';
      document.getElementById('chatSection').style.display = 'block';

      // Conecta ao WebSocket
      connectWebSocket();
      
      // Carrega histórico
      loadMessages();
    }

    // Função para desconectar do chat atual
    function disconnectFromChat() {
      if (ws) {
        ws.close();
        ws = null;
      }
      currentReceiverId = null;
      document.getElementById('selectReceiverSection').style.display = 'block';
      document.getElementById('chatSection').style.display = 'none';
      document.getElementById('messagesQueue').innerHTML = '';
    }

    // Função para conectar ao WebSocket
    function connectWebSocket() {
      const wsUrl = API_URL.replace('http', 'ws') + '/ws/chat';
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        console.log('WebSocket conectado');
        // Envia mensagem de autenticação
        ws.send(JSON.stringify({
          type: 'auth',
          token: token
        }));
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log(data)
        if (data.type === 'auth_success') {
          console.log('Autenticação realizada com sucesso');
          currentUserId = data.user_id;
        } else if (data.type === 'message') {
          // Recebeu uma mensagem
          displayMessage(data);
        } else if (data.type === 'error') {
          alert('Erro: ' + data.message);
          if (data.message.includes('Token')) {
            window.location.href = '/html/login.html';
          }
        }
      };

      ws.onerror = (error) => {
        console.error('Erro no WebSocket:', error);
        alert('Erro na conexão WebSocket');
      };

      ws.onclose = () => {
        console.log('WebSocket desconectado');
      };
    }

    // Função para exibir mensagem na tela
    function displayMessage(message) {
      const messagesQueue = document.getElementById('messagesQueue');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message';
      
      const isOwnMessage = message.sender_id === currentUserId;
      messageDiv.classList.add(isOwnMessage ? 'own-message' : 'other-message');
      
      const timestamp = new Date(message.timestamp).toLocaleString('pt-BR');
      
      messageDiv.innerHTML = `
        <div class="message-info">
          <span class="username">${isOwnMessage ? 'Você' : 'Outro usuário'}</span>
          <span class="time">${timestamp}</span>
          <div class="message-text">${escapeHtml(message.content)}</div>
        </div>
      `;
      
      messagesQueue.appendChild(messageDiv);
      messagesQueue.scrollTop = messagesQueue.scrollHeight;
    }

    // Função para escapar HTML (prevenir XSS)
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Função para enviar mensagem
    const form = document.getElementById('InsertForm');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const messageInput = document.getElementById('messageInput');
      const content = messageInput.value.trim();

      if (!content) {
        return;
      }

      if (!ws || ws.readyState !== WebSocket.OPEN) {
        alert('WebSocket não está conectado. Reconectando...');
        connectWebSocket();
        return;
      }

      if (!currentReceiverId) {
        alert('Selecione um destinatário primeiro');
        return;
      }

      // Envia mensagem via WebSocket
      ws.send(JSON.stringify({
        type: 'message',
        receiver_id: currentReceiverId,
        content: content
      }));

      // Limpa o input
      messageInput.value = '';
    });

    // Função para carregar histórico de mensagens
    async function loadMessages() {
      if (!currentReceiverId || !token) {
        return;
      }

      try {
        const response = await fetch(`${API_URL}/messages/history/${currentReceiverId}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const messages = await response.json();
          const messagesQueue = document.getElementById('messagesQueue');
          messagesQueue.innerHTML = '';

          messages.forEach(msg => {
            displayMessage(msg);
          });
        } else {
          console.error('Erro ao carregar histórico');
        }
      } catch (error) {
        console.error('Erro ao carregar mensagens:', error);
      }
    }

    // Função para desconectar e sair
    function disconnect() {
      if (ws) {
        ws.close();
      }
      localStorage.removeItem('token');
      alert('✅ Desconectando....');
      window.location.href = '/html/login.html';
    }

    // Enter key no input de destinatário
    document.getElementById('receiverIdInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        connectToChat();
      }
    });

    loadMessages();
    setInterval(loadMessages, 5000);
  </script>
</body>
</html>
