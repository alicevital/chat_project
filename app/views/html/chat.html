<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - Chat Privado</title>
    <link rel="stylesheet" href="../styles/styles.css">
</head>
<body>

<div class="chat-container">

    <!-- ================= HOME ================= -->
    <div id="homeSection">

        <header class="chat-header">
            Bem-vindo
        </header>

        <div class="receiver-section">

            <h3>Escolha uma opção</h3>

            <!-- Botão para Chat Global -->
            <button onclick="window.location.href='/html/chat_global.html'">
                Ir para Chat Global
            </button>

            <div class="divider-text">ou</div>

            <!-- Input para room_id -->
            <div class="input-group">
                <label for="roomInput">ID da Sala Privada:</label>
                <input type="text" id="roomInput" placeholder="Digite o room_id">
            </div>

            <button id="enterPrivateBtn">Entrar no Chat Privado</button>
        </div>
    </div>

    <!-- ================= CHAT PRIVADO ================= -->
    <div id="privateChatSection" class="chat-section" style="display:none;">

        <header class="chat-header">
            <span>Chat Privado</span>
            <button class="back-btn" onclick="goBackHome()">Voltar</button>
        </header>

        <div class="chat-info">
            <p><strong>Sala:</strong> <span id="roomName">---</span></p>
        </div>

        <div class="chat-box" id="messagesBox"></div>

        <form class="chat-form" id="privateMessageForm">
            <input type="text" id="privateMessageInput" placeholder="Digite sua mensagem..." required>
            <button type="submit">Enviar</button>
        </form>
    </div>

</div>

<script>

    // --------------- FUNÇÃO PARA PEGAR O USUÁRIO LOGADO ---------------
    async function loadUser() {
        const userId = localStorage.getItem("user_id");

        if (!userId) {
            alert("Usuário não autenticado!");
            return null;
        }

        const res = await fetch(`http://localhost:8000/users/${userId}`);
        const user = await res.json();
        return user.name;
    }


    // --------------- NAVEGAR DE HOME PARA O CHAT PRIVADO ---------------
    document.getElementById("enterPrivateBtn").addEventListener("click", async () => {
        const roomId = document.getElementById("roomInput").value.trim();

        if (roomId === "") {
            alert("Digite um room_id!");
            return;
        }

        const username = await loadUser();
        if (!username) return;

        // atualizar info
        document.getElementById("roomName").textContent = roomId;

        // mostrar tela do chat e ocultar home
        document.getElementById("homeSection").style.display = "none";
        document.getElementById("privateChatSection").style.display = "flex";

        startPrivateChat(roomId, username);
    });


    // --------------- CONECTAR AO CHAT PRIVADO ---------------
    function startPrivateChat(roomId, username) {

        const socket = new WebSocket(`ws://localhost:8000/ws/private/${roomId}/${username}`);

        const messagesBox = document.getElementById("messagesBox");
        const form = document.getElementById("privateMessageForm");
        const input = document.getElementById("privateMessageInput");

        socket.onmessage = (event) => {
            addMessage(event.data, username);
        };

        function addMessage(text, username) {
            const div = document.createElement("div");

            const isOwnMessage = text.includes(` ${username}:`);

            div.classList.add("message", isOwnMessage ? "own-message" : "other-message");
            div.innerText = text;

            messagesBox.appendChild(div);
            messagesBox.scrollTop = messagesBox.scrollHeight;
        }

        form.addEventListener("submit", (e) => {
            e.preventDefault();

            const msg = input.value.trim();
            if (msg !== "") {
                socket.send(msg);
                input.value = "";
            }
        });
    }


    // --------------- VOLTAR PARA HOME ---------------
    function goBackHome() {
        document.getElementById("privateChatSection").style.display = "none";
        document.getElementById("homeSection").style.display = "block";
        document.getElementById("messagesBox").innerHTML = "";
    }

</script>

</body>
</html>